name: CompatHelper
on:
  schedule:
    - cron: '00 00 * * *'
  workflow_dispatch:
jobs:
  CompatHelper:
    runs-on: ubuntu-latest
    steps:
      - name: Pkg.add("CompatHelper")
        run: julia -e 'using Pkg; Pkg.add("CompatHelper")'
      - name: CompatHelper.main()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMPATHELPER_PRIV: ${{ secrets.ORBITALTRAJECTORIES_DEPLOY_SSH_KEY }}
        run: julia -e '
          using CompatHelper;
          using Pkg;
          Pkg.activate(".");
          Pkg.add(["TOML"]);
          using TOML;
          CompatHelper.main() do;
            CompatHelper.update_manifests(); 
            proj = Pkg.project();
            proj_toml = nothing;
            open(proj.path; read=true) do file;
              global proj_toml = TOML.parse(file);
            end;
            open(proj.path; write=true) do file;
              version = VersionNumber(proj_toml["version"]);
              new_version = Base.nextpatch(version);
              io = IOBuffer();
              print(io, new_version);
              proj_toml["version"] = String(take!(io));
              TOML.print(file, proj_toml; sorted = true, by = key -> (Pkg.Types.project_key_order(key), key));
            end;
          end;'